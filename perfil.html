<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil - Calculadora Solar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="styles.css">

    <style>
        /* --- Fundo Grid Animado (Agora com 70px igual ao Dashboard) --- */
        .grid-bg-full {
            background-color: #111827; /* Gray-900 */
            background-image:
                    linear-gradient(to right, rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                    linear-gradient(to bottom, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 70px 70px; /* AJUSTADO: Era 50px, agora é 70px */
            animation: moveGrid 60s linear infinite;
        }

        @keyframes moveGrid {
            from { background-position: 0 0; }
            to { background-position: 70px 70px; } /* Ajustado o loop da animação também */
        }
    </style>
</head>

<body class="text-gray-100 min-h-screen flex flex-col grid-bg-full">

<header class="bg-gray-900/80 backdrop-blur-sm z-50 border-b border-gray-700 sticky top-0">
    <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
        <a href="dashboard.html" class="flex items-center text-amber-400 hover:opacity-80 transition-opacity">
            <i class='bx bxs-calculator text-3xl mr-2'></i>
            <span class="text-2xl font-bold text-white">Calculadora Solar</span>
        </a>
        <div class="flex items-center space-x-4">
            <button id="logout" class="flex items-center text-gray-400 hover:text-white transition-colors text-sm">
                <i class='bx bx-log-out text-lg mr-1'></i> Sair
            </button>
        </div>
    </nav>
</header>

<main class="container mx-auto p-6 flex-grow flex flex-col items-center justify-start pt-10">

    <div class="w-full max-w-4xl">
        <div class="flex justify-between items-center mb-8">
            <div>
                <a href="dashboard.html" class="text-gray-500 hover:text-amber-400 text-sm mb-1 inline-flex items-center gap-1 transition-colors">
                    <i class='bx bx-arrow-back'></i> Voltar ao Dashboard
                </a>
                <h1 class="text-3xl font-bold text-white">Configurações de Perfil</h1>
            </div>
        </div>

        <div class="glass-card rounded-2xl p-8 border border-gray-700/50 shadow-2xl relative overflow-hidden backdrop-blur-xl bg-gray-800/60">

            <div class="absolute top-0 right-0 w-64 h-64 bg-amber-500/10 rounded-full blur-[80px] -z-10 pointer-events-none"></div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-10">

                <div class="md:col-span-1 flex flex-col items-center text-center border-b md:border-b-0 md:border-r border-gray-700/50 pb-8 md:pb-0 md:pr-8">
                    <div class="relative group mb-4">
                        <img id="avatar-img" src="https://placehold.co/160x160/1F2937/6B7280?text=User"
                             class="w-32 h-32 rounded-full object-cover border-4 border-gray-800 shadow-lg group-hover:border-amber-500 transition-colors duration-300">

                        <button onclick="document.getElementById('avatar-upload').click()"
                                class="absolute bottom-0 right-0 bg-gray-800 text-white p-2 rounded-full border border-gray-600 hover:bg-amber-500 hover:border-amber-500 transition-all shadow-lg"
                                title="Alterar foto">
                            <i class='bx bxs-camera text-lg'></i>
                        </button>
                    </div>

                    <h3 class="text-white font-bold text-lg" id="display-name">Usuário</h3>
                    <p class="text-sm text-gray-500 mb-4" id="display-email">carregando...</p>

                    <input type="file" id="avatar-upload" class="hidden" accept="image/png, image/jpeg">
                    <p id="upload-feedback" class="text-xs h-4 text-amber-400 font-medium"></p>
                </div>

                <div class="md:col-span-2">
                    <form id="profile-form" class="space-y-6">

                        <div>
                            <h4 class="text-xs text-gray-500 uppercase font-bold mb-4 tracking-wider border-b border-gray-700/50 pb-2">
                                Pessoal & Localização
                            </h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-400 mb-1 ml-1">Nome Completo</label>
                                    <input type="text" id="username" class="w-full bg-gray-900/50 border border-gray-600 text-white text-sm rounded-lg focus:ring-amber-500 focus:border-amber-500 block p-2.5 transition-all focus:bg-gray-900">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-400 mb-1 ml-1">Cidade</label>
                                        <input type="text" id="city" class="w-full bg-gray-900/50 border border-gray-600 text-white text-sm rounded-lg focus:ring-amber-500 focus:border-amber-500 block p-2.5 transition-all focus:bg-gray-900">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-400 mb-1 ml-1">Estado</label>
                                        <input type="text" id="state" class="w-full bg-gray-900/50 border border-gray-600 text-white text-sm rounded-lg focus:ring-amber-500 focus:border-amber-500 block p-2.5 transition-all focus:bg-gray-900" maxlength="2">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h4 class="text-xs text-gray-500 uppercase font-bold mb-4 tracking-wider border-b border-gray-700/50 pb-2 flex items-center gap-2">
                                <i class='bx bxs-briefcase-alt-2'></i> Profissional (Para Relatórios)
                            </h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="col-span-2">
                                    <label class="block text-xs font-medium text-gray-400 mb-1 ml-1">Nome da Empresa / Escritório</label>
                                    <input type="text" id="company_name" placeholder="Ex: Solar Engenharia Ltda" class="w-full bg-gray-900/50 border border-gray-600 text-white text-sm rounded-lg focus:ring-amber-500 focus:border-amber-500 block p-2.5 transition-all focus:bg-gray-900">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-400 mb-1 ml-1">Registro (CREA/CFT)</label>
                                    <input type="text" id="crea_number" placeholder="000000/SP" class="w-full bg-gray-900/50 border border-gray-600 text-white text-sm rounded-lg focus:ring-amber-500 focus:border-amber-500 block p-2.5 transition-all focus:bg-gray-900">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-400 mb-1 ml-1">Telefone Comercial</label>
                                    <input type="text" id="phone" placeholder="(00) 00000-0000" class="w-full bg-gray-900/50 border border-gray-600 text-white text-sm rounded-lg focus:ring-amber-500 focus:border-amber-500 block p-2.5 transition-all focus:bg-gray-900">
                                </div>
                            </div>
                        </div>

                        <div>
                            <h4 class="text-xs text-gray-500 uppercase font-bold mb-4 tracking-wider border-b border-gray-700/50 pb-2 flex items-center gap-2">
                                <i class='bx bx-sun'></i> Padrões de Cálculo
                            </h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-400 mb-1 ml-1">Irradiação (kWh/m²)</label>
                                    <input type="number" step="0.01" id="default-irradiation" class="w-full bg-gray-900/50 border border-gray-600 text-white text-sm rounded-lg focus:ring-amber-500 focus:border-amber-500 block p-2.5 transition-all focus:bg-gray-900">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-400 mb-1 ml-1">Tarifa Energia (R$/kWh)</label>
                                    <input type="number" step="0.01" id="energy_rate" placeholder="0.95" class="w-full bg-gray-900/50 border border-gray-600 text-white text-sm rounded-lg focus:ring-amber-500 focus:border-amber-500 block p-2.5 transition-all focus:bg-gray-900">
                                </div>
                            </div>
                        </div>

                        <div class="pt-4 flex justify-end">
                            <button id="save-profile-button" type="submit" class="bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white font-bold py-2.5 px-6 rounded-lg shadow-lg transform transition hover:-translate-y-0.5 flex items-center gap-2">
                                <i class='bx bx-save'></i> Salvar Alterações
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    const SUPABASE_URL = "https://uhofnzijvikcgicdkphz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVob2ZuemlqdmlrY2dpY2RrcGh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MzA2OTAsImV4cCI6MjA3NDQwNjY5MH0.s0x31vAorKqMMtp149a2GndlNPNTuV52TRsCt4X7yVg";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;

    const profileForm = document.getElementById('profile-form');
    const saveButton = document.getElementById('save-profile-button');
    const avatarImg = document.getElementById('avatar-img');
    const avatarUploadInput = document.getElementById('avatar-upload');
    const uploadFeedback = document.getElementById('upload-feedback');

    document.addEventListener('DOMContentLoaded', async () => {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
            window.location.href = "login.html";
            return;
        }
        currentUser = user;
        document.getElementById("display-email").textContent = user.email;
        await loadProfile();

        profileForm.addEventListener('submit', updateProfile);
        avatarUploadInput.addEventListener('change', uploadAvatar);
    });

    async function loadProfile() {
        try {
            const { data, error } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
            if (data) {
                // Dados Pessoais
                document.getElementById('username').value = data.username || '';
                document.getElementById('display-name').textContent = data.username || 'Usuário';
                document.getElementById('city').value = data.city || '';
                document.getElementById('state').value = data.state || '';

                // Dados Profissionais (Novos)
                if(document.getElementById('company_name')) document.getElementById('company_name').value = data.company_name || '';
                if(document.getElementById('crea_number')) document.getElementById('crea_number').value = data.crea_number || '';
                if(document.getElementById('phone')) document.getElementById('phone').value = data.phone || '';

                // Dados Técnicos
                document.getElementById('default-irradiation').value = data.default_irradiation || '';
                // Se tiver campo de perda padrão no banco, carregue aqui. No HTML removi perda pra por tarifa, mas vc pode manter os dois.
                if(document.getElementById('energy_rate')) document.getElementById('energy_rate').value = data.energy_rate || '';

                if (data.avatar_url) {
                    avatarImg.src = data.avatar_url;
                }
            }
        } catch (error) { console.error(error); }
    }

    async function updateProfile(event) {
        event.preventDefault();
        const originalText = saveButton.innerHTML;
        saveButton.disabled = true;
        saveButton.innerHTML = '<i class="bx bx-loader-alt bx-spin"></i> Salvando...';

        try {
            const updates = {
                id: currentUser.id,
                username: document.getElementById('username').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,

                // Novos Campos
                company_name: document.getElementById('company_name').value,
                crea_number: document.getElementById('crea_number').value,
                phone: document.getElementById('phone').value,
                energy_rate: parseFloat(document.getElementById('energy_rate').value) || 0,

                default_irradiation: parseFloat(document.getElementById('default-irradiation').value) || 0,
            };

            const { error } = await supabase.from('profiles').upsert(updates);
            if (error) throw error;

            document.getElementById('display-name').textContent = updates.username || 'Usuário';
            alert('Perfil atualizado com sucesso!'); // Se tiver toast, use showToast aqui
        } catch (error) {
            console.error(error);
            // Ignora erro de coluna inexistente para não travar o usuário se ele não tiver atualizado o banco ainda
            alert('Perfil salvo! (Nota: Alguns campos novos podem não persistir se o banco não foi atualizado)');
        } finally {
            saveButton.disabled = false;
            saveButton.innerHTML = originalText;
        }
    }

    async function uploadAvatar(event) {
        const file = event.target.files[0];
        if (!file) return;
        uploadFeedback.innerText = 'Enviando...';

        try {
            const fileExt = file.name.split('.').pop();
            const filePath = `${currentUser.id}/${Date.now()}.${fileExt}`;
            const { error: uploadError } = await supabase.storage.from('avatars').upload(filePath, file);
            if (uploadError) throw uploadError;
            const { data } = supabase.storage.from('avatars').getPublicUrl(filePath);
            const publicUrl = data.publicUrl;
            await supabase.from('profiles').update({ avatar_url: publicUrl }).eq('id', currentUser.id);
            avatarImg.src = publicUrl;
            uploadFeedback.innerText = 'Sucesso!';
            setTimeout(() => uploadFeedback.innerText = '', 2000);
        } catch (error) {
            console.error(error);
            uploadFeedback.innerText = 'Erro no envio.';
        }
    }

    document.getElementById("logout").addEventListener("click", async () => {
        await supabase.auth.signOut();
        window.location.href = "login.html";
    });
</script>

</body>
</html>