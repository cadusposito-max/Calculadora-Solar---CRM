<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Projeto - Calculadora Solar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="styles.css">
    <style>
        .grid-bg-full {
            background-color: #111827;
            background-image:
                    linear-gradient(to right, rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                    linear-gradient(to bottom, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 70px 70px;
            animation: moveGrid 60s linear infinite;
        }
        @keyframes moveGrid {
            from { background-position: 0 0; }
            to { background-position: 70px 70px; }
        }

        .modern-input {
            background-color: rgba(17, 24, 39, 0.5);
            border: 1px solid #4b5563;
            color: #f3f4f6;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
        .modern-input:focus {
            border-color: #f59e0b;
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2);
            outline: none;
            background-color: rgba(17, 24, 39, 0.8);
        }

        /* Animações do Toast (Copiadas do styles.css para garantir funcionamento local se precisar) */
        @keyframes slideInBounce {
            0% { transform: translateX(120%); opacity: 0; }
            60% { transform: translateX(-10%); opacity: 1; }
            80% { transform: translateX(5%); }
            100% { transform: translateX(0); }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(120%); opacity: 0; }
        }
        .toast-enter { animation: slideInBounce 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .toast-exit { animation: slideOutRight 0.4s ease-in forwards; }
    </style>
</head>

<body class="text-gray-100 min-h-screen flex flex-col grid-bg-full font-sans">

<header class="bg-gray-900/80 backdrop-blur-sm z-50 border-b border-gray-700 sticky top-0">
    <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
        <a href="index.html" class="flex items-center text-amber-400 hover:opacity-80 transition-opacity">
            <i class='bx bxs-calculator text-3xl mr-2'></i>
            <span class="text-2xl font-bold text-white">Calculadora Solar</span>
        </a>
        <div class="flex items-center space-x-4">
            <span id="user-email" class="text-sm text-gray-400 hidden sm:block"></span>
            <button id="logout" class="flex items-center text-gray-400 hover:text-white transition-colors text-sm">
                <i class='bx bx-log-out text-lg mr-1'></i> Sair
            </button>
        </div>
    </nav>
</header>

<main class="flex-grow container mx-auto p-6 pt-10">
    <div class="w-full max-w-6xl mx-auto space-y-8">

        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <a href="dashboard.html" class="text-gray-500 hover:text-amber-400 text-sm mb-1 inline-flex items-center gap-1 transition-colors">
                    <i class='bx bx-arrow-back'></i> Voltar para Projetos
                </a>
                <h1 class="text-3xl font-bold text-white flex items-center gap-2">
                    Gerenciar <span class="text-gradient-amber">Projeto</span>
                </h1>
            </div>

            <div class="flex gap-3">
                <a id="detail-calculator-link" href="#" class="bg-gray-800 hover:bg-gray-700 text-white font-bold py-2.5 px-5 rounded-xl border border-gray-600 transition-all flex items-center gap-2 shadow-lg">
                    <i class='bx bx-calculator text-xl text-amber-500'></i> Abrir Calculadora
                </a>
                <button id="save-details-button" class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white font-bold py-2.5 px-6 rounded-xl shadow-lg shadow-green-900/20 transform transition hover:-translate-y-0.5 flex items-center gap-2">
                    <i class='bx bxs-save text-xl'></i> Salvar Alterações
                </button>
            </div>
        </div>

        <form id="details-form" class="space-y-8">

            <div class="glass-card rounded-2xl p-8 border border-gray-700/50 shadow-xl relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1 h-full bg-amber-500"></div>

                <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                    <i class='bx bxs-user-detail text-amber-500'></i> Informações do Cliente
                </h2>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Nome do Projeto</label>
                            <input type="text" id="form-nome_projeto" placeholder="Ex: Residência Silva" class="modern-input w-full p-3">
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Tipo de Pessoa</label>
                            <div class="flex gap-4 bg-gray-900/50 p-2 rounded-lg border border-gray-600 w-fit">
                                <label class="flex items-center cursor-pointer gap-2 text-sm text-gray-300 hover:text-white">
                                    <input type="radio" name="tipo_cliente" value="PF" class="accent-amber-500 w-4 h-4"> Pessoa Física
                                </label>
                                <label class="flex items-center cursor-pointer gap-2 text-sm text-gray-300 hover:text-white">
                                    <input type="radio" name="tipo_cliente" value="PJ" class="accent-amber-500 w-4 h-4"> Pessoa Jurídica
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Nome do Cliente</label>
                            <input type="text" id="form-nome_cliente" placeholder="Nome completo" class="modern-input w-full p-3">
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div id="pf-fields">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">CPF</label>
                            <input type="text" id="form-cpf_cnpj_pf" placeholder="000.000.000-00" class="modern-input w-full p-3">
                        </div>
                        <div id="pj-fields" class="hidden">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">CNPJ</label>
                            <input type="text" id="form-cpf_cnpj_pj" placeholder="00.000.000/0000-00" class="modern-input w-full p-3">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Email</label>
                                <input type="email" id="form-email" placeholder="contato@email.com" class="modern-input w-full p-3">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Telefone</label>
                                <input type="text" id="form-telefone" placeholder="(00) 00000-0000" class="modern-input w-full p-3">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Endereço da Instalação</label>
                            <input type="text" id="form-endereco" placeholder="Rua, Número, Bairro, Cidade - UF" class="modern-input w-full p-3">
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-card rounded-2xl p-8 border border-gray-700/50 shadow-xl relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>

                <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                    <i class='bx bx-sun text-blue-500'></i> Dados Técnicos Iniciais
                </h2>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Qtd. Módulos</label>
                        <input type="number" id="form-moduleCount" class="modern-input w-full p-3 font-mono text-amber-400 font-bold">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Potência (Wp)</label>
                        <input type="number" id="form-modulePower" class="modern-input w-full p-3">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Irradiação</label>
                        <input type="number" id="form-irradiation" step="0.01" class="modern-input w-full p-3">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Perdas (%)</label>
                        <input type="number" id="form-systemLosses" class="modern-input w-full p-3">
                    </div>
                </div>
            </div>
        </form>

        <div class="glass-card rounded-2xl p-8 border border-gray-700/50 shadow-xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                    <i class='bx bx-folder-open text-purple-500'></i> Documentos do Projeto
                </h2>
            </div>

            <div class="flex items-center gap-4 mb-6 bg-gray-900/30 p-4 rounded-xl border border-gray-700 border-dashed">
                <input type="file" id="file-upload"
                       class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-amber-500 file:text-gray-900 hover:file:bg-amber-400 cursor-pointer transition-colors" />
                <button id="upload-button" class="bg-gray-700 hover:bg-white hover:text-gray-900 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2 font-medium">
                    <i class='bx bx-cloud-upload text-xl'></i> Enviar
                </button>
            </div>

            <div id="file-list" class="space-y-3"></div>
        </div>

    </div>
</main>

<div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-3"></div>

<script>
    const SUPABASE_URL = "https://uhofnzijvikcgicdkphz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVob2ZuemlqdmlrY2dpY2RrcGh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MzA2OTAsImV4cCI6MjA3NDQwNjY5MH0.s0x31vAorKqMMtp149a2GndlNPNTuV52TRsCt4X7yVg";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentProjectId = null;
    const saveButton = document.getElementById('save-details-button');

    // --- FUNÇÃO TOAST (VISUAL E ELÁSTICA) ---
    function showToast(message, type = 'success') {
        let container = document.getElementById('toast-container');
        const el = document.createElement('div');
        const styles = type === 'success'
            ? 'bg-gray-800 border-l-4 border-green-500 text-green-100 shadow-[0_0_15px_rgba(34,197,94,0.3)]'
            : 'bg-gray-800 border-l-4 border-red-500 text-red-100 shadow-[0_0_15px_rgba(239,68,68,0.3)]';
        const icon = type === 'success'
            ? "<i class='bx bxs-check-circle text-2xl text-green-500'></i>"
            : "<i class='bx bxs-error-circle text-2xl text-red-500'></i>";

        el.className = `${styles} px-6 py-4 rounded-r shadow-2xl flex items-center gap-4 min-w-[300px] toast-enter relative overflow-hidden`;
        el.innerHTML = `
            ${icon}
            <div>
                <h4 class="font-bold text-sm uppercase tracking-wide">${type === 'success' ? 'Sucesso' : 'Erro'}</h4>
                <span class="text-sm opacity-90">${message}</span>
            </div>
            <div class="absolute bottom-0 left-0 h-1 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} transition-all duration-[3000ms] ease-linear w-full"></div>
        `;
        container.appendChild(el);
        setTimeout(() => {
            const bar = el.querySelector('div:last-child');
            if(bar) bar.style.width = '0%';
        }, 50);
        setTimeout(() => {
            el.classList.replace('toast-enter', 'toast-exit');
            el.addEventListener('animationend', () => el.remove());
        }, 3000);
    }

    document.addEventListener('DOMContentLoaded', () => {
        checkUser();
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('id');

        if (!projectId) {
            showToast("ID do projeto não encontrado. Redirecionando...", "error");
            setTimeout(() => window.location.href = 'dashboard.html', 1500);
            return;
        }
        currentProjectId = projectId;
        loadProjectDetails(projectId);
    });

    async function checkUser() {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) window.location.href = "login.html";
        else document.getElementById("user-email").textContent = user.email;
    }

    document.getElementById("logout").addEventListener("click", async () => {
        await supabase.auth.signOut();
        window.location.href = "login.html";
    });

    async function loadProjectDetails(projectId) {
        const { data, error } = await supabase.from('calculos_salvos').select('*').eq('id', projectId).single();
        if (error || !data) {
            showToast("Projeto não encontrado ou acesso negado.", "error");
            setTimeout(() => window.location.href = 'dashboard.html', 1500);
            return;
        }
        document.getElementById('form-nome_projeto').value = data.nome_projeto || '';
        document.getElementById('detail-calculator-link').href = `calculadora.html?id=${projectId}`;
        document.querySelector(`input[name="tipo_cliente"][value="${data.tipo_cliente || 'PF'}"]`).checked = true;
        toggleClientFields();
        document.getElementById('form-nome_cliente').value = data.nome_cliente || '';
        if (data.tipo_cliente === 'PJ') document.getElementById('form-cpf_cnpj_pj').value = data.cpf_cnpj || '';
        else document.getElementById('form-cpf_cnpj_pf').value = data.cpf_cnpj || '';
        document.getElementById('form-email').value = data.email || '';
        document.getElementById('form-telefone').value = data.telefone || '';
        document.getElementById('form-endereco').value = data.endereco || '';

        if (data.dados_completos) {
            document.getElementById('form-moduleCount').value = data.dados_completos.moduleCount || '';
            document.getElementById('form-modulePower').value = data.dados_completos.modulePower || '';
            document.getElementById('form-irradiation').value = data.dados_completos.irradiation || '';
            document.getElementById('form-systemLosses').value = data.dados_completos.systemLosses || '';
        }
        loadProjectFiles(projectId);
    }

    saveButton.addEventListener('click', async (event) => {
        event.preventDefault();
        await saveDetails();
    });

    async function saveDetails() {
        if (!currentProjectId) {
            showToast("Erro: ID do projeto não encontrado.", "error");
            return;
        }

        const originalButtonText = saveButton.innerHTML;
        saveButton.disabled = true;
        saveButton.innerHTML = `<i class='bx bx-loader-alt animate-spin mr-2'></i> Salvando...`;

        try {
            const tipo_cliente = document.querySelector('input[name="tipo_cliente"]:checked').value;
            const nome_cliente = document.getElementById('form-nome_cliente').value;
            const cpf_cnpj = (tipo_cliente === 'PF') ? document.getElementById('form-cpf_cnpj_pf').value : document.getElementById('form-cpf_cnpj_pj').value;
            const email = document.getElementById('form-email').value;
            const telefone = document.getElementById('form-telefone').value;
            const endereco = document.getElementById('form-endereco').value;
            const moduleCount = parseInt(document.getElementById('form-moduleCount').value) || 0;
            const modulePower = parseInt(document.getElementById('form-modulePower').value) || 0;
            const irradiation = parseFloat(document.getElementById('form-irradiation').value.replace(',', '.')) || 0;
            const systemLosses = parseFloat(document.getElementById('form-systemLosses').value.replace(',', '.')) || 0;
            const potencia_pico_kwp = (moduleCount * modulePower) / 1000;
            const performanceRatio = 1 - (systemLosses / 100);
            const geracao_media_kwh = (potencia_pico_kwp * irradiation * 30.4) * performanceRatio;

            const { data: oldData } = await supabase.from('calculos_salvos').select('dados_completos').eq('id', currentProjectId).single();
            const oldDadosCompletos = oldData ? oldData.dados_completos : {};

            const updateData = {
                nome_projeto: document.getElementById('form-nome_projeto').value,
                tipo_cliente, nome_cliente, cpf_cnpj, email, telefone, endereco, potencia_pico_kwp, geracao_media_kwh, total_modulos: moduleCount,
                dados_completos: { ...oldDadosCompletos, moduleCount, modulePower, irradiation, systemLosses }
            };

            const { error } = await supabase.from('calculos_salvos').update(updateData).eq('id', currentProjectId);

            if (error) {
                showToast("Erro ao salvar: " + error.message, "error");
            } else {
                showToast("Alterações salvas com sucesso!", "success");
            }

        } catch (e) {
            showToast("Ocorreu um erro inesperado.", "error");
            console.error(e);
        } finally {
            saveButton.disabled = false;
            saveButton.innerHTML = originalButtonText;
        }
    }

    const clientTypeRadios = document.querySelectorAll('input[name="tipo_cliente"]');
    function toggleClientFields() {
        const selectedType = document.querySelector('input[name="tipo_cliente"]:checked').value;
        document.getElementById('pf-fields').classList.toggle('hidden', selectedType !== 'PF');
        document.getElementById('pj-fields').classList.toggle('hidden', selectedType !== 'PJ');
    }
    clientTypeRadios.forEach(radio => radio.addEventListener('change', toggleClientFields));

    // --- LÓGICA DE ARQUIVOS ---
    const fileInput = document.getElementById('file-upload');
    const uploadButton = document.getElementById('upload-button');

    async function loadProjectFiles(projectId) {
        const fileListDiv = document.getElementById('file-list');
        fileListDiv.innerHTML = '<p class="text-gray-500 italic text-sm text-center py-4">Carregando arquivos...</p>';
        const { data: fileList, error: listError } = await supabase.storage.from('documentos_projetos').list(projectId);

        if (listError || !fileList || fileList.length === 0) {
            fileListDiv.innerHTML = `
            <div class="flex flex-col items-center justify-center py-8 text-gray-600 border-2 border-dashed border-gray-700 rounded-xl">
                <i class='bx bx-folder-open text-4xl mb-2'></i>
                <p class="text-sm">Nenhum documento anexado.</p>
            </div>`;
            return;
        }

        const fileItems = await Promise.all(fileList.map(async (file) => {
            const { data } = await supabase.storage.from('documentos_projetos').createSignedUrl(`${projectId}/${file.name}`, 3600);
            if (!data) return '';
            const signedUrl = data.signedUrl;
            const filePath = `${projectId}/${file.name}`;

            return `
            <div class="flex justify-between items-center p-4 bg-gray-800/50 border border-gray-700 rounded-xl hover:bg-gray-700 hover:border-amber-500/30 transition-all group">
                <div class="flex items-center flex-grow min-w-0">
                    <div class="w-10 h-10 rounded-lg bg-gray-900 flex items-center justify-center text-amber-500 mr-4 border border-gray-700">
                        <i class='bx bxs-file-pdf text-xl'></i>
                    </div>
                    <div class="min-w-0">
                        <p class="text-sm text-gray-200 font-medium truncate pr-4 group-hover:text-white transition-colors">${file.name}</p>
                        <p class="text-xs text-gray-500">Documento do projeto</p>
                    </div>
                </div>
                <div class="flex items-center gap-2 flex-shrink-0 opacity-60 group-hover:opacity-100 transition-opacity">
                    <a href="${signedUrl}" target="_blank" class="bg-gray-900 hover:bg-amber-500 hover:text-gray-900 text-gray-400 p-2 rounded-lg border border-gray-600 hover:border-amber-500 transition-all" title="Visualizar">
                        <i class='bx bx-show text-lg'></i>
                    </a>
                    <button data-path="${filePath}" class="download-button bg-gray-900 hover:bg-white hover:text-gray-900 text-gray-400 p-2 rounded-lg border border-gray-600 hover:border-white transition-all" title="Baixar">
                        <i class='bx bx-download text-lg'></i>
                    </button>
                </div>
            </div>`;
        }));
        fileListDiv.innerHTML = fileItems.join('');
    }

    uploadButton.addEventListener('click', async () => {
        const file = fileInput.files[0];
        if (!file) { showToast("Selecione um arquivo.", "error"); return; }
        if (!currentProjectId) { showToast("ID do projeto não encontrado.", "error"); return; }

        const filePath = `${currentProjectId}/${file.name}`;
        uploadButton.disabled = true;
        uploadButton.innerHTML = '<i class="bx bx-loader-alt animate-spin"></i>';

        const { error } = await supabase.storage.from('documentos_projetos').upload(filePath, file, { upsert: true });

        if (error) {
            showToast("Erro ao enviar: " + error.message, "error");
        } else {
            showToast("Arquivo enviado com sucesso!", "success");
            loadProjectFiles(currentProjectId);
        }
        uploadButton.disabled = false;
        uploadButton.innerHTML = "<i class='bx bx-cloud-upload text-xl'></i> Enviar";
        fileInput.value = "";
    });

    document.getElementById('file-list').addEventListener('click', async (event) => {
        const downloadButton = event.target.closest('.download-button');
        if (downloadButton) {
            const filePath = downloadButton.dataset.path;
            if (!filePath) return;
            downloadButton.disabled = true;
            const icon = downloadButton.querySelector('i');
            icon.className = 'bx bx-loader-alt animate-spin text-lg';
            try {
                const { data: blob, error } = await supabase.storage.from('documentos_projetos').download(filePath);
                if (error) throw error;
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = filePath.split('/').pop();
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                showToast("Erro ao baixar: " + error.message, "error");
            } finally {
                downloadButton.disabled = false;
                icon.className = 'bx bx-download text-lg';
            }
        }
    });
</script>
</body>
</html>